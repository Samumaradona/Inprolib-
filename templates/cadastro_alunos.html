<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Cadastro de usuário no INPROLIB com validações e segurança." />
  <title>INPROLIB - Cadastro de usuário</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/cadastro_alunos.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/notifications.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
</head>
<body>
  <div id="app">
<header class="topbar">
  <div class="container">
    <!-- LADO ESQUERDO: apenas botão de retorno -->
    <div class="left">
        <button id="btnBack" class="notif-btn" type="button" aria-label="Voltar">
          <span class="material-symbols-outlined">keyboard_return</span>
        </button>
    </div>
</header>

    <main>
      <nav aria-label="breadcrumb" style="margin:8px 16px;color:#64748b">
        <a href="/home" style="color:#1d4ed8;text-decoration:none">Home</a> · Cadastro de usuário
      </nav>
      {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
          <script>
            window.FLASH_MESSAGES = {{ messages|tojson|safe }};
          </script>
        {% endif %}
      {% endwith %}
        <!-- Toolbar: filtros à esquerda -->
        {% if session.get('role') or session.get('user_tipo') %}
        <div class="toolbar" style="margin:0 16px 12px 16px; display:flex; gap:12px; justify-content:space-between; align-items:center">
          <div class="filters" id="filterBar" style="display:flex; gap:8px; align-items:center">
            <div class="input-with-icon">
              <span class="material-symbols-outlined" aria-hidden="true">search</span>
              <input type="text" id="searchUser" placeholder="Buscar usuários..." aria-label="Buscar usuários">
            </div>
            <select id="statusFilter" aria-label="Filtrar status">
              <option value="all">Todos</option>
              <option value="active">Ativos</option>
              <option value="inactive">Inativos</option>
            </select>
            <button type="button" id="btnClearFilters" class="button is-sm with-icon" title="Limpar filtros">
              <span class="material-symbols-outlined" aria-hidden="true">filter_alt_off</span>
              Limpar filtros
            </button>
            <span id="resultsCounter" class="results-counter" aria-live="polite"></span>
          </div>

        </div>

        {% if usuarios and usuarios|length > 0 %}
        <section id="usersList" class="form-container" aria-label="Lista de usuários" style="margin-bottom:16px">
          <h3 style="margin-bottom:12px">Usuários cadastrados</h3>
          <div style="overflow:auto;border:1px solid #e5e7eb;border-radius:8px">
            <table style="width:100%;border-collapse:collapse">
              <thead>
                <tr style="text-align:left;background:#f8fafc">
                  <th style="padding:8px;border-bottom:1px solid #e5e7eb">Nome</th>
                  <th style="padding:8px;border-bottom:1px solid #e5e7eb">E-mail</th>
                  <th style="padding:8px;border-bottom:1px solid #e5e7eb">CPF</th>
                  <th style="padding:8px;border-bottom:1px solid #e5e7eb">Tipo</th>
                  <th style="padding:8px;border-bottom:1px solid #e5e7eb">Curso</th>
                  <th style="padding:8px;border-bottom:1px solid #e5e7eb">Ações</th>
                </tr>
              </thead>
              <tbody>
                {% for u in usuarios %}
                <tr data-nome="{{ u.nome }}" data-email="{{ u.email or '' }}" data-cpf="{{ u.cpf or '' }}" data-tipo="{{ u.tipo or '' }}" data-curso="{{ u.curso_usuario or '' }}" data-ativo="{{ '1' if u.ativo else '0' }}">
                  <td style="padding:8px;border-bottom:1px solid #f1f5f9">{{ u.nome }}</td>
                  <td style="padding:8px;border-bottom:1px solid #f1f5f9">{{ u.email or '-' }}</td>
                  <td style="padding:8px;border-bottom:1px solid #f1f5f9">{{ u.cpf or '-' }}</td>
                  <td style="padding:8px;border-bottom:1px solid #f1f5f9">{{ u.tipo or '-' }}</td>
                  <td style="padding:8px;border-bottom:1px solid #f1f5f9">{{ u.curso_usuario or '-' }}</td>
                  <td style="padding:8px;border-bottom:1px solid #f1f5f9">
                    <div class="action-buttons">
                      <button type="button"
class="icon-btn is-blue"
aria-label="Editar usuário {{ u.nome }}"
title="Editar"
data-action="edit-user"
data-id="{{ u.id_usuario }}">
<span class="material-symbols-outlined" aria-hidden="true">edit</span>
</button>
                       <form method="POST" action="/cadastro_alunos" style="display:inline">
                         <input type="hidden" name="action" value="toggle">
                         <input type="hidden" name="id_usuario" value="{{ u.id_usuario }}">

<button type="submit" class="icon-btn {{ 'is-danger' if u.ativo else 'is-success' }}" aria-label="{{ 'Inativar' if u.ativo else 'Reativar' }} usuário {{ u.nome }}" title="{{ 'Inativar' if u.ativo else 'Reativar' }}">
                           <span class="material-symbols-outlined" aria-hidden="true">{{ 'do_not_disturb_on' if u.ativo else 'check_circle' }}</span>
                         </button>
                       </form>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </section>
        {% endif %}
{% else %}
        <h3 style="margin:0 16px 12px 16px">Adicionar aluno</h3>
        <form id="usuarioForm" class="form-container" method="POST" action="/cadastro_alunos" novalidate>
          <input type="hidden" name="action" id="user_action" value="create">
          <input type="hidden" name="id_usuario" id="user_id" value="">
          <div class="container-grid">
            <div>
              <h3>Informações do usuário</h3>
              <label for="nome_user">Nome</label>
              <input type="text" id="nome_user" name="nome_user" placeholder="Insira o seu nome completo" required maxlength="255">
              <label for="cpf_user">CPF</label>
              <input type="text" id="cpf_user" name="cpf_user" placeholder="Insira o seu CPF" required inputmode="numeric" maxlength="14" pattern="\d{3}\.\d{3}\.\d{3}-\d{2}" title="Formato: 000.000.000-00">
              <label for="email_user">Email</label>
              <input type="email" id="email_user" name="email_user" placeholder="Insira o seu email" required autocomplete="email">
              <label for="tipo_usuario">Tipo de Usuário</label>
              <select id="tipo_usuario" name="tipo_usuario" required>
                <option value="Docente">Docente</option>
                <option value="Aluno" selected>Aluno</option>
              </select>
            </div>
            <div>
               <label for="cep_user">CEP</label>
               <input type="text" id="cep_user" name="cep_user" placeholder="00000-000" inputmode="numeric" maxlength="9" autocomplete="postal-code">
               <div id="cepFeedback" style="font-size:12px;color:#64748b;margin:4px 0" aria-live="polite"></div>
               <label for="logradouro">Rua (Logradouro)</label>
               <input type="text" id="logradouro" name="logradouro" placeholder="Ex.: Avenida Brasil, 1000" autocomplete="address-line1">
               <label for="complemento">Complemento</label>
               <input type="text" id="complemento" name="complemento" placeholder="Ex.: Apto 202" autocomplete="address-line2">
               <label for="bairro">Bairro</label>
               <input type="text" id="bairro" name="bairro" placeholder="Ex.: Centro" autocomplete="address-level3">
               <label for="cidade">Cidade</label>
               <input type="text" id="cidade" name="cidade" placeholder="Ex.: São Paulo" autocomplete="address-level2">
               <label for="estado">Estado</label>
               <input type="text" id="estado" name="estado" placeholder="UF" maxlength="2" style="text-transform:uppercase" autocomplete="address-level1">
               <div id="senhaGroup">
                 <label for="senha">Senha</label>
                 <input type="password" id="senha" name="senha" placeholder="Insira a sua senha" required minlength="8" autocomplete="new-password">
                 <div id="pwdStrength" style="font-size:12px;color:#64748b;margin:4px 0">Força da senha: fraca</div>
               </div>
               <div id="confirmarGroup">
                 <label for="confirmar_senha">Confirmar senha</label>
                 <input type="password" id="confirmar_senha" name="confirmar_senha" placeholder="Confirme a sua senha" required autocomplete="new-password">
               </div>
               <div id="captchaGroup">
                 <label for="captcha">Captcha: {{ captcha_question }}</label>
                 <input type="text" id="captcha" name="captcha" placeholder="Digite o resultado" required inputmode="numeric" pattern="\d+" title="Digite apenas números">
               </div>
             </div>
             <div class="full-width">
               <button class="button" type="submit">Salvar</button>
             </div>
           </div>
         </form>
{% endif %}

{% if session.get('role') or session.get('user_tipo') %}
<!-- Modal de criação/edição de usuário -->
<div id="usuarioModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="usuarioModalTitle">
<div class="modal-content">
<button id="closeUsuarioModal" class="modal-close" aria-label="Fechar">✕</button>
<h3 id="usuarioModalTitle" style="margin:0 0 12px 0">Adicionar usuário</h3>
<form id="usuarioForm" class="form-container" method="POST" action="/cadastro_alunos" novalidate>
<input type="hidden" name="action" id="user_action" value="create">
<input type="hidden" name="id_usuario" id="user_id" value="">
<div class="container-grid">
<div>
<h3>Informações do usuário</h3>
<label for="nome_user">Nome</label>
<input type="text" id="nome_user" name="nome_user" placeholder="Insira o seu nome completo" required maxlength="255">
<label for="cpf_user">CPF</label>
<input type="text" id="cpf_user" name="cpf_user" placeholder="Insira o seu CPF" required inputmode="numeric" maxlength="14" pattern="\d{3}\.\d{3}\.\d{3}-\d{2}" title="Formato: 000.000.000-00">
<label for="email_user">Email</label>
<input type="email" id="email_user" name="email_user" placeholder="Insira o seu email" required autocomplete="email">
<label for="tipo_usuario">Tipo de Usuário</label>
<select id="tipo_usuario" name="tipo_usuario" required>
<option value="Docente">Docente</option>
<option value="Aluno" selected>Aluno</option>
</select>
</div>
<div>
<label for="cep_user">CEP</label>
<input type="text" id="cep_user" name="cep_user" placeholder="00000-000" inputmode="numeric" maxlength="9" autocomplete="postal-code">
<div id="cepFeedback" style="font-size:12px;color:#64748b;margin:4px 0" aria-live="polite"></div>
<label for="logradouro">Rua (Logradouro)</label>
<input type="text" id="logradouro" name="logradouro" placeholder="Ex.: Avenida Brasil, 1000" autocomplete="address-line1">
<label for="complemento">Complemento</label>
<input type="text" id="complemento" name="complemento" placeholder="Ex.: Apto 202" autocomplete="address-line2">
<label for="bairro">Bairro</label>
<input type="text" id="bairro" name="bairro" placeholder="Ex.: Centro" autocomplete="address-level3">
<label for="cidade">Cidade</label>
<input type="text" id="cidade" name="cidade" placeholder="Ex.: São Paulo" autocomplete="address-level2">
<label for="estado">Estado</label>
<input type="text" id="estado" name="estado" placeholder="UF" maxlength="2" style="text-transform:uppercase" autocomplete="address-level1">
<div id="senhaGroup">
<label for="senha">Senha</label>
<input type="password" id="senha" name="senha" placeholder="Insira a sua senha" required minlength="8" autocomplete="new-password">
<div id="pwdStrength" style="font-size:12px;color:#64748b;margin:4px 0">Força da senha: fraca</div>
</div>
<div id="confirmarGroup">
<label for="confirmar_senha">Confirmar senha</label>
<input type="password" id="confirmar_senha" name="confirmar_senha" placeholder="Confirme a sua senha" required autocomplete="new-password">
</div>
<div id="captchaGroup">
<label for="captcha">Captcha: {{ captcha_question }}</label>
<input type="text" id="captcha" name="captcha" placeholder="Digite o resultado" required inputmode="numeric" pattern="\d+" title="Digite apenas números">
</div>
</div>
<div class="full-width">
<button class="button" type="submit">Salvar</button>
<button type="button" id="btnCloseUserForm" class="button" style="background:#6b7280">Fechar</button>
</div>
</div>
</form>
</div>
</div>

    </main>
  </div>

  {% endif %}

  <script>window.USER_ROLE = "{{ (session.get('role') or session.get('user_tipo') or '') }}";</script>
  <script src="{{ url_for('static', filename='javascript/notifications.js') }}"></script>
  <script src="{{ url_for('static', filename='javascript/home.js') }}"></script>
  <script>window.initFlashToasts && window.initFlashToasts();</script>
  <script>
    // Validação em tempo real de CPF e email; indicador de força de senha
    (function(){
      const cpfInput = document.getElementById('cpf_user');
      const emailInput = document.getElementById('email_user');
      const senhaInput = document.getElementById('senha');
      const confirmarInput = document.getElementById('confirmar_senha');
      const strengthEl = document.getElementById('pwdStrength');
      function validarCPF(cpf){
        cpf = (cpf||'').replace(/[^0-9]/g,'');
        if(cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
        let soma=0; for(let i=0;i<9;i++) soma+=parseInt(cpf[i])*(10-i);
        let resto = 11 - (soma % 11); let d1 = resto >= 10 ? 0 : resto;
        soma=0; for(let i=0;i<10;i++) soma+=parseInt(cpf[i])*(11-i);
        resto = 11 - (soma % 11); let d2 = resto >= 10 ? 0 : resto;
        return cpf.slice(9) === `${d1}${d2}`;
      }
      // CEP e preenchimento automático (ViaCEP)
      const cepInput = document.getElementById('cep_user');
      const logradouroInput = document.getElementById('logradouro');
      const complementoInput = document.getElementById('complemento');
      const bairroInput = document.getElementById('bairro');
      const cidadeInput = document.getElementById('cidade');
      const estadoInput = document.getElementById('estado');
      const cepFeedback = document.getElementById('cepFeedback');

      function onlyDigits(s){ return (s||'').replace(/[^0-9]/g,''); }
      function formatCEP(v){ const d = onlyDigits(v).slice(0,8); return d.length>5 ? d.slice(0,5)+'-'+d.slice(5) : d; }

      async function buscarCEP(cepDigits){
        if(!cepDigits || cepDigits.length !== 8) return;
        try{
          if(cepFeedback){ cepFeedback.textContent = 'Consultando CEP...'; cepFeedback.style.color = '#64748b'; }
          let data = null;
          try {
            const resp = await fetch(`https://viacep.com.br/ws/${cepDigits}/json/`);
            if (resp.ok) data = await resp.json();
          } catch(e) { /* ignore */ }
          if (!data || data.erro) {
            try {
              const resp2 = await fetch(`https://brasilapi.com.br/api/cep/v1/${cepDigits}`);
              if (resp2.ok) {
                const d2 = await resp2.json();
                data = {
                  logradouro: d2.street || '',
                  complemento: '',
                  bairro: d2.neighborhood || '',
                  localidade: d2.city || '',
                  uf: d2.state || ''
                };
              }
            } catch(e) { /* ignore */ }
          }
          if(data && !data.erro){
            if(logradouroInput) logradouroInput.value = data.logradouro || '';
            if(complementoInput) complementoInput.value = data.complemento || '';
            if(bairroInput) bairroInput.value = data.bairro || '';
            if(cidadeInput) cidadeInput.value = data.localidade || '';
            if(estadoInput) estadoInput.value = (data.uf || '').toUpperCase();
            if(cepFeedback){ cepFeedback.textContent = 'Endereço preenchido pelo CEP.'; cepFeedback.style.color = '#16a34a'; }
          } else {
            if(cepFeedback){ cepFeedback.textContent = 'CEP não encontrado.'; cepFeedback.style.color = '#dc2626'; }
          }
        }catch(e){
          if(cepFeedback){ cepFeedback.textContent = 'Falha ao consultar CEP.'; cepFeedback.style.color = '#dc2626'; }
        }
      }
      function emailValido(e){ return /.+@.+\..+/.test(e); }
      function scoreSenha(s){
        let score = 0;
        if((s||'').length >= 8) score++;
        if(/[A-Z]/.test(s)) score++;
        if(/[a-z]/.test(s)) score++;
        if(/\d/.test(s)) score++;
        if(/[^A-Za-z0-9]/.test(s)) score++;
        return score;
      }
      if(senhaInput && strengthEl){
        senhaInput.addEventListener('input', ()=>{
          const score = scoreSenha(senhaInput.value);
          const map = ['fraca','média','boa','forte','muito forte'];
          strengthEl.textContent = `Força da senha: ${map[Math.min(score,4)]}`;
        });
      }
      if(cpfInput){
        cpfInput.addEventListener('input', ()=>{
          cpfInput.setCustomValidity(validarCPF(cpfInput.value)? '' : 'CPF inválido');
        });
      }
      if(cepInput){
        cepInput.addEventListener('input', (e)=>{
          const v = formatCEP(e.target.value);
          e.target.value = v;
          const d = (v||'').replace(/\D/g,'');
          if(d.length === 8){ buscarCEP(d); }
        });
        cepInput.addEventListener('blur', (e)=>{
          const d = (e.target.value||'').replace(/\D/g,'');
          if(d.length === 8){ buscarCEP(d); }
        });
      }
      if(emailInput){
        emailInput.addEventListener('input', ()=>{
          emailInput.setCustomValidity(emailValido(emailInput.value)? '' : 'E-mail inválido');
        });
      }
      if(confirmarInput && senhaInput){
        confirmarInput.addEventListener('input', ()=>{
          confirmarInput.setCustomValidity(confirmarInput.value === senhaInput.value ? '' : 'As senhas não coincidem');
        });
      }
    })();
  </script>
  <script>
    (function(){
      const searchInput = document.getElementById('searchUser');
      const statusSelect = document.getElementById('statusFilter');
      const clearBtn = document.getElementById('btnClearFilters');
      const resultsEl = document.getElementById('resultsCounter');
      const tbody = document.querySelector('#usersList tbody');
      function applyUserFilters(){
        if(!tbody){ if(resultsEl) resultsEl.textContent = ''; return; }
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const q = (searchInput?.value || '').trim().toLowerCase();
        const status = (statusSelect?.value || 'all');
        let visible = 0;
        rows.forEach(row => {
          const nome = (row.dataset.nome || '').toLowerCase();
          const email = (row.dataset.email || '').toLowerCase();
          const cpf = (row.dataset.cpf || '').toLowerCase();
          const tipo = (row.dataset.tipo || '').toLowerCase();
          const curso = (row.dataset.curso || '').toLowerCase();
          const ativo = row.dataset.ativo === '1';
          let matchText = true;
          if(q){
            matchText = nome.includes(q) || email.includes(q) || cpf.includes(q) || tipo.includes(q) || curso.includes(q);
          }
          let matchStatus = true;
          if(status === 'active') matchStatus = ativo;
          else if(status === 'inactive') matchStatus = !ativo;
          const show = matchText && matchStatus;
          row.style.display = show ? '' : 'none';
          if(show) visible++;
        });
        if(resultsEl){
          const total = rows.length;
          resultsEl.textContent = `Exibindo ${visible} de ${total}`;
        }
      }
      if(searchInput) searchInput.addEventListener('input', applyUserFilters);
      if(statusSelect) statusSelect.addEventListener('change', applyUserFilters);
      if(clearBtn) clearBtn.addEventListener('click', ()=>{
        if(searchInput) searchInput.value = '';
        if(statusSelect) statusSelect.value = 'all';
        applyUserFilters();
      });
      applyUserFilters();
    })();
  </script>
  <script>
    // Modal e ação de editar/criar usuário
    (function(){
      const modal = document.getElementById('usuarioModal');
      const form = document.getElementById('usuarioForm');
      const title = document.getElementById('usuarioModalTitle');
      const btnOpen = document.getElementById('btnToggleUserForm');
      const btnClose = document.getElementById('closeUsuarioModal');
      const btnCloseForm = document.getElementById('btnCloseUserForm');

      const actionInput = document.getElementById('user_action');
      const idInput = document.getElementById('user_id');
      const nomeInput = document.getElementById('nome_user');
      const cpfInput = document.getElementById('cpf_user');
      const emailInput = document.getElementById('email_user');
      const tipoSelect = document.getElementById('tipo_usuario');
      const senhaInput = document.getElementById('senha');
      const confirmarInput = document.getElementById('confirmar_senha');
      const captchaInput = document.getElementById('captcha');
      const senhaGroup = document.getElementById('senhaGroup');
      const confirmarGroup = document.getElementById('confirmarGroup');
      const captchaGroup = document.getElementById('captchaGroup');

      function openModal(){ modal.setAttribute('aria-hidden','false'); modal.classList.add('open'); setTimeout(()=>{ nomeInput && nomeInput.focus(); }, 0); }
      function closeModal(){ modal.setAttribute('aria-hidden','true'); modal.classList.remove('open'); }

      function normalizeDigits(v){ return String(v||'').replace(/\D+/g,''); }
      function formatCPF(d){ const s = normalizeDigits(d); if(s.length !== 11) return d || ''; return `${s.slice(0,3)}.${s.slice(3,6)}.${s.slice(6,9)}-${s.slice(9)}`; }

      function prepareCreate(){
        actionInput.value = 'create';
        idInput.value = '';
        nomeInput.value = '';
        cpfInput.value = '';
        emailInput.value = '';
        tipoSelect.value = 'Aluno';
        // limpa endereço
        const cep = document.getElementById('cep_user');
        const logradouro = document.getElementById('logradouro');
        const complemento = document.getElementById('complemento');
        const bairro = document.getElementById('bairro');
        const cidade = document.getElementById('cidade');
        const estado = document.getElementById('estado');
        const fb = document.getElementById('cepFeedback');
        if(cep) cep.value=''; if(logradouro) logradouro.value=''; if(complemento) complemento.value=''; if(bairro) bairro.value=''; if(cidade) cidade.value=''; if(estado) estado.value='';
        if(fb){ fb.textContent=''; fb.style.color='#64748b'; }
        senhaInput.required = true; confirmarInput.required = true; captchaInput.required = true;
        senhaGroup.style.display = ''; confirmarGroup.style.display = ''; captchaGroup.style.display = '';
        title.textContent = 'Adicionar usuário';
        openModal();
      }
      function prepareEdit(fromBtn){
        const tr = fromBtn.closest('tr');
        const tipo = (tr?.dataset.tipo || '').trim();
        actionInput.value = 'update';
        idInput.value = fromBtn.getAttribute('data-id') || '';
        nomeInput.value = tr?.dataset.nome || '';
        cpfInput.value = formatCPF(tr?.dataset.cpf || '');
        emailInput.value = tr?.dataset.email || '';
        const tipoNorm = tipo.toLowerCase();
        tipoSelect.value = ((tipoNorm === 'professor' || tipoNorm === 'docente') ? 'Docente' : 'Aluno');
        // Oculta campos de senha/captcha na edição
        senhaInput.required = false; confirmarInput.required = false; captchaInput.required = false;
        senhaGroup.style.display = 'none'; confirmarGroup.style.display = 'none'; captchaGroup.style.display = 'none';
        title.textContent = 'Editar usuário';
        openModal();
      }

      if(btnOpen){ btnOpen.addEventListener('click', prepareCreate); }
      if(btnClose){ btnClose.addEventListener('click', closeModal); }
      if(btnCloseForm){ btnCloseForm.addEventListener('click', closeModal); }
      if(modal){ modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); }); }
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });

      document.querySelectorAll('[data-action="edit-user"]').forEach(btn => {
        btn.addEventListener('click', function(){ prepareEdit(this); });
      });
    })();
  </script>
</body>
</html>
