<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>INPROLIB - Emissão de Relatórios</title>
  <link rel="stylesheet" href="relatorio.css">
  <link rel="stylesheet" href="notifications.css?v=1">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
</head>
<body>
  <div id="app">
<header class="topbar">
  <div class="container">
    <!-- LADO ESQUERDO: apenas hambúrguer -->
    <div class="left">
      <button class="hamburger" id="btnHamburger" aria-controls="sideMenu" aria-expanded="false" aria-label="Abrir menu" title="Abrir menu">
        <span class="material-symbols-outlined" aria-hidden="true">menu</span>
      </button>
            <div class="profile-wrap" style="position:relative">
        <button id="btnProfile" class="profile-btn" aria-haspopup="true" aria-expanded="false" aria-label="Abrir menu do usuário">
          <img id="profileAvatar" class="avatar" src="{{ url_for('static', filename=session.get('user_photo')) if session.get('user_photo') else 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTqf7MJNlh6GfxfrjCep_dnXOBm0EwGc0X12A&s' }}" alt="Avatar usuário">
        </button>
        <div id="profileDropdown" class="dropdown-menu" role="menu" aria-hidden="true">
          <button id="viewPhoto" class="dropdown-action" role="menuitem">Ver foto</button>
          <button id="changePhoto" class="dropdown-action" role="menuitem">Mudar foto</button>
        </div>
        <input id="fileAvatarInput" type="file" accept="image/*" style="display:none" aria-hidden="true">
      </div>
      <div>
        <p id="username">{{ session.get('user_name', '') }}</p>
      </div>
    </div>
    <!-- LADO DIREITO: notificações + avatar -->
    <div class="right" role="group" aria-label="Ações do usuário">
      <!-- Notification button -->
      <div class="notif-wrap" style="position:relative">
        <button id="btnNotifications" class="notif-btn" aria-haspopup="true" aria-expanded="false" aria-label="Notificações">
          <span class="material-symbols-outlined" aria-hidden="true">notifications</span>
          <span id="notifBadge" class="notif-badge" aria-hidden="true" style="display:none"></span>
        </button>
        <div id="notificationsDropdown" class="dropdown-menu" role="menu" aria-hidden="true">
          <div class="dropdown-item">Você não tem novas notificações</div>
        </div>
      </div>
      <!-- profile avatar -->
    </div>
  </div>
</header>
<!-- modal de visualização da foto -->
<div id="avatarModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="avatarModalTitle">
  <div class="modal-content">
    <button id="closeModal" class="modal-close" aria-label="Fechar visualização">✕</button>
    <h3 id="avatarModalTitle" style="margin:0 0 12px 0">Foto do usuário</h3>
    <img id="modalAvatarImg" src="" alt="Foto do usuário" style="max-width:100%;border-radius:8px">
  </div>
</div>
    <!-- Backdrop e menu lateral -->
    <div id="backdrop" class="backdrop" tabindex="-1" aria-hidden="true"></div>
    <aside id="sideMenu" class="sidemenu" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="sideMenuTitle">
      <header>
        <div>
          <strong id="sideMenuTitle">INPROLIB</strong>
          <div style="font-size:12px;color:#64748b">Menu</div>
        </div>
        <div>
          <button id="btnClose" aria-label="Fechar menu" title="Fechar">✕</button>
        </div>
      </header>
      <nav class="routes" id="routesList">
        <!-- rotas inseridas por JS -->
      </nav>
      <footer>
        <a id="logoutBtn" class="route" href="/logout"><span class="material-symbols-outlined">logout</span>Sair</a>
      </footer>
    </aside>
    <main>
  <form class="form-container" id="formRelatorio" autocomplete="off">
     <h3>Emissão de Relatórios</h3>
    <!-- Coluna 1 -->
    <div class="container-grid">
    <div>
      <label for="autor">Autor</label>
      <input type="text" id="autor" name="autor" placeholder="Digite o nome do autor">

      <label for="orientador">Orientado/Professor</label>
      <select id="orientador" name="orientador">
        <option value="">Selecione o orientado/professor</option>
        {% if autores %}
          {% for a in autores %}
            <option value="{{ a.id_usuario }}">{{ a.nome }}</option>
          {% endfor %}
        {% endif %}
      </select>
      <label for="curso">Curso</label>
      <select id="curso" name="curso">
        <option value="">Selecione o curso</option>
        {% if cursos %}
          {% for c in cursos %}
            <option value="{{ c.id_curso }}">{{ c.nome_curso }}</option>
          {% endfor %}
        {% endif %}
      </select>

      <label for="tipo">Tipo de publicação</label>
      <select id="tipo" name="tipo">
        <option value="">Selecione o tipo de publicação</option>
        {% if tipos %}
          {% for t in tipos %}
            <option value="{{ t.nome_tipo }}">{{ t.nome_tipo }}</option>
          {% endfor %}
        {% endif %}
      </select>

    </div>

    <!-- Coluna 2 -->
    <div>
      <label for="data_inicial">Data inicial</label>
      <input type="date" id="data_inicial" name="data_inicial">
      <label for="data_final">Data Final</label>
      <input type="date" id="data_final" name="data_final">
    </div>

    <!-- Botão centralizado -->
    <div class="full-width">
      <button class="button" id="btnPreviewReport" type="button">Visualizar relatórios</button>
    </div>
    </div>
  </form>

    </main>
  </div>

  <script>
    window.USER_ROLE = "{{ (session.get('role') or session.get('user_tipo') or '') }}";
    window.USER_PHOTO = "{{ url_for('static', filename=session.get('user_photo')) if session.get('user_photo') else '' }}";
window.USER_ID = "{{ session.get('user_id', '') }}";
    window.USER_NAME = "{{ (session.get('user_name') or '') }}";
  </script>
  <!-- Modal de visualização -->
  <div id="reportModal" class="modal" style="display:none;position:fixed;inset:0;z-index:1000;">
    <div class="backdrop" style="position:absolute;inset:0;background:rgba(15,23,42,.5)"></div>
    <div role="dialog" aria-modal="true" aria-labelledby="reportModalTitle" class="modal-card" style="position:relative;margin:48px auto;background:#fff;border-radius:12px;max-width:960px;width:calc(100% - 32px);box-shadow:0 10px 30px rgba(0,0,0,.2);">
      <header style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #e5e7eb">
        <h4 id="reportModalTitle" style="margin:0">Pré-visualização do Relatório</h4>
        <button id="closeReportModal" aria-label="Fechar" class="button is-sm" style="background:#e2e8f0;color:#0f172a">Fechar</button>
      </header>
      <section style="padding:16px 20px;max-height:60vh;overflow:auto">
        <div id="colConfig" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:8px">
          <div style="font-weight:500">Colunas visíveis</div>
          <button id="btnColsAll" class="button is-sm" type="button" style="background:#e2e8f0;color:#0f172a">Selecionar tudo</button>
          <button id="btnColsNone" class="button is-sm" type="button" style="background:#e2e8f0;color:#0f172a">Limpar seleção</button>
          <div id="colCheckboxes" style="display:flex;flex-wrap:wrap;gap:12px"></div>
        </div>
        <table id="reportTable" style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="background:#f8fafc">
              <th data-sort="id_publicacao" style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;cursor:pointer">ID</th>
              <th data-sort="titulo" style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;cursor:pointer">Título</th>
              <th data-sort="tipo" style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;cursor:pointer">Tipo</th>
              <th data-sort="autor" style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;cursor:pointer">Autor</th>
              <th data-sort="curso" style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;cursor:pointer">Curso</th>
              <th data-sort="data_publicacao" style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;cursor:pointer">Data</th>
              <th data-sort="status" style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;cursor:pointer">Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="reportPager" style="display:none;gap:8px;align-items:center;justify-content:flex-start;padding:8px 0">
          <button id="pgPrev" class="button is-sm" style="background:#e2e8f0;color:#0f172a">Anterior</button>
          <span id="pgInfo" style="color:#64748b">Página 1 de 1</span>
          <button id="pgNext" class="button is-sm" style="background:#e2e8f0;color:#0f172a">Próxima</button>
          <span style="margin-left:12px;color:#64748b">Itens por página</span>
          <select id="pgSize" class="input is-sm" style="width:auto">
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
        <div id="reportEmpty" style="display:none;color:#475569;padding:12px">Nenhum resultado encontrado com os filtros informados.</div>
      </section>
      <footer style="padding:12px 20px;border-top:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center">
        <small id="reportCount" style="color:#64748b">0 resultados</small>
        <div id="reportActions" style="display:flex;gap:8px">
          <a id="btnDownloadExcel" class="button" href="#" role="button">Excel</a>
          <a id="btnDownloadPDF" class="button" href="#" role="button">PDF</a>
        </div>
      </footer>
    </div>
  </div>

  <script src="notifications.js?v=1"></script>
  <script src="home.js?v=aval-fix-1"></script>
  <script>
    window.initFlashToasts && window.initFlashToasts();

    (function(){
      const form = document.getElementById('formRelatorio');
      const btnPreview = document.getElementById('btnPreviewReport');
      const modal = document.getElementById('reportModal');
      const closeBtn = document.getElementById('closeReportModal');
      const table = document.getElementById('reportTable');
      const tableBody = table.querySelector('tbody');
      const empty = document.getElementById('reportEmpty');
      const count = document.getElementById('reportCount');
      const pager = document.getElementById('reportPager');
      const pgPrev = document.getElementById('pgPrev');
      const pgNext = document.getElementById('pgNext');
      const pgInfo = document.getElementById('pgInfo');
      const pgSize = document.getElementById('pgSize');
      const btnExcel = document.getElementById('btnDownloadExcel');
      const btnPDF = document.getElementById('btnDownloadPDF');
      const colBoxes = document.getElementById('colCheckboxes');
      const btnColsAll = document.getElementById('btnColsAll');
      const btnColsNone = document.getElementById('btnColsNone');

      let allRows = [];
      let sortKey = 'data_publicacao';
      let sortDir = 'desc';
      let page = 1;
      let pageSize = parseInt((pgSize && pgSize.value) || '10', 10);

      const FILTERS_KEY = 'inprolib_relatorio_filters::' + (window.USER_NAME || 'anon');
      const COLS_KEY = 'inprolib_relatorio_cols::' + (window.USER_NAME || 'anon');
      const ALL_COLS = [
        { key: 'id_publicacao', label: 'ID' },
        { key: 'titulo', label: 'Título' },
        { key: 'tipo', label: 'Tipo' },
        { key: 'autor', label: 'Autor' },
        { key: 'curso', label: 'Curso' },
        { key: 'data_publicacao', label: 'Data' },
        { key: 'status', label: 'Status' },
        { key: 'assuntos', label: 'Assuntos' }
      ];
      const labelByKey = Object.fromEntries(ALL_COLS.map(c => [c.key, c.label]));
      let selectedCols = [];

      function loadSavedFilters(){
        try{
          const raw = localStorage.getItem(FILTERS_KEY);
          if(!raw) return;
          const f = JSON.parse(raw);
          ['autor','orientador','curso','tipo','data_inicial','data_final'].forEach(k=>{
            const el = form.querySelector(`[name="${k}"]`);
            if(el && f[k] != null) el.value = f[k];
          });
        }catch(e){}
      }

      function saveFilters(){
        try{
          const obj = {};
          ['autor','orientador','curso','tipo','data_inicial','data_final'].forEach(k=>{
            const el = form.querySelector(`[name="${k}"]`);
            obj[k] = el ? el.value : '';
          });
          localStorage.setItem(FILTERS_KEY, JSON.stringify(obj));
        }catch(e){}
      }

      function loadSavedCols(){
        try{
          const raw = localStorage.getItem(COLS_KEY);
          const arr = raw ? JSON.parse(raw) : null;
          if(Array.isArray(arr)){
            selectedCols = arr.filter(k => ALL_COLS.some(c => c.key === k));
          }
        }catch(e){}
        if(!selectedCols || selectedCols.length === 0){
          selectedCols = ALL_COLS.map(c => c.key);
        }
        if(!selectedCols.includes(sortKey)){
          sortKey = selectedCols[0];
        }
      }

      function saveCols(){
        try{ localStorage.setItem(COLS_KEY, JSON.stringify(selectedCols)); }catch(e){}
      }

      function renderColumnControls(){
        if(!colBoxes) return;
        colBoxes.innerHTML = '';
        ALL_COLS.forEach(c => {
          const lbl = document.createElement('label');
          lbl.className = 'form-check-label';
          const inp = document.createElement('input');
          inp.type = 'checkbox'; inp.className = 'form-check-input'; inp.dataset.key = c.key;
          inp.checked = selectedCols.includes(c.key);
          lbl.appendChild(inp);
          lbl.appendChild(document.createTextNode(' ' + c.label));
          colBoxes.appendChild(lbl);
          inp.addEventListener('change', () => {
            const key = c.key;
            const idx = selectedCols.indexOf(key);
            if(inp.checked && idx === -1) selectedCols.push(key);
            if(!inp.checked && idx !== -1) selectedCols.splice(idx, 1);
            if(selectedCols.length === 0){
              // manter pelo menos uma coluna
              selectedCols = ['titulo'];
              Array.from(colBoxes.querySelectorAll('input[type="checkbox"]')).forEach(cb=>{ cb.checked = (cb.dataset.key === 'titulo'); });
            }
            saveCols();
            if(!selectedCols.includes(sortKey)){
              sortKey = selectedCols[0];
            }
            buildHeader();
            page = 1;
            renderTable();
            updateDownloadURLs();
          });
        });
      }

      function openModal(){ modal.style.display='block'; document.body.style.overflow='hidden'; }
      function closeModal(){ modal.style.display='none'; document.body.style.overflow=''; }

      closeBtn.addEventListener('click', closeModal);
      modal.querySelector('.backdrop').addEventListener('click', closeModal);

      function updatePager(){
        const total = allRows.length;
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        page = Math.min(page, totalPages);
        if(pager){
          pager.style.display = total > 0 ? 'flex' : 'none';
        }
        if(pgInfo){
          pgInfo.textContent = `Página ${total ? page : 0} de ${total ? totalPages : 0}`;
        }
        if(count){
          count.textContent = `${total} ${total === 1 ? 'resultado' : 'resultados'}`;
        }
        if(pgPrev) pgPrev.disabled = page <= 1;
        if(pgNext) pgNext.disabled = page >= totalPages;
      }

      function normalize(val){
        if(val == null) return '';
        if(typeof val === 'string') return val.toLowerCase();
        return val;
      }

      function compare(a, b){
        const key = sortKey;
        let va = a[key];
        let vb = b[key];
        if(key === 'data_publicacao'){
          try { va = new Date(a[key]); vb = new Date(b[key]); } catch(e){}
        }
        va = normalize(va);
        vb = normalize(vb);
        if(va < vb) return sortDir === 'asc' ? -1 : 1;
        if(va > vb) return sortDir === 'asc' ? 1 : -1;
        return 0;
      }

      function bindSortHandlers(){
        table.querySelectorAll('thead th[data-sort]').forEach(th=>{
          th.addEventListener('click', ()=>{
            const key = th.dataset.sort;
            if(sortKey === key){
              sortDir = sortDir === 'asc' ? 'desc' : 'asc';
            } else {
              sortKey = key;
              sortDir = 'asc';
            }
            page = 1;
            renderTable();
          });
        });
      }

      function renderHeaders(){
        const ths = table.querySelectorAll('thead th[data-sort]');
        ths.forEach(th=>{
          const baseLabel = th.dataset.label || th.textContent.trim();
          const key = th.dataset.sort;
          if(key === sortKey){
            th.textContent = `${baseLabel} ${sortDir === 'asc' ? '▲' : '▼'}`;
          } else {
            th.textContent = baseLabel;
          }
        });
      }

      function buildHeader(){
        const thead = table.querySelector('thead');
        if(!thead) return;
        const tr = document.createElement('tr');
        tr.style.background = '#f8fafc';
        selectedCols.forEach(k => {
          const th = document.createElement('th');
          th.dataset.sort = k;
          th.style.textAlign = 'left';
          th.style.padding = '8px';
          th.style.borderBottom = '1px solid #e5e7eb';
          th.style.cursor = 'pointer';
          th.dataset.label = labelByKey[k];
          th.textContent = labelByKey[k];
          tr.appendChild(th);
        });
        thead.innerHTML = '';
        thead.appendChild(tr);
        bindSortHandlers();
        renderHeaders();
      }

      function renderTable(){
        tableBody.innerHTML = '';
        const total = allRows.length;
        if(!total){
          empty.style.display = 'block';
          updatePager();
          return;
        }
        empty.style.display = 'none';
        const sorted = [...allRows].sort(compare);
        const start = (page - 1) * pageSize;
        const end = Math.min(start + pageSize, sorted.length);
        for(let i=start; i<end; i++){
          const r = sorted[i];
          const tr = document.createElement('tr');
          let html = '';
          selectedCols.forEach(k => {
            let v = r[k];
            html += `<td style="padding:8px;border-bottom:1px solid #f1f5f9">${v ?? ''}</td>`;
          });
          tr.innerHTML = html;
          tableBody.appendChild(tr);
        }
        updatePager();
        renderHeaders();
      }

      // Atualiza selectedCols baseado nos checkboxes visíveis
      function updateSelectedCols(){
        if(!colBoxes) return;
        selectedCols = Array.from(colBoxes.querySelectorAll('input[type="checkbox"]'))
          .filter(cb => cb.checked)
          .map(cb => cb.dataset.key || cb.value)
          .filter(Boolean);
        if(selectedCols.length === 0){
          selectedCols = ['titulo'];
          colBoxes.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.checked = (cb.dataset.key === 'titulo' || cb.value === 'titulo');
          });
        }
        saveCols();
        if(!selectedCols.includes(sortKey)) sortKey = selectedCols[0];
        buildHeader();
        page = 1;
        renderTable();
        updateDownloadURLs();
      }

      // Serializa filtros do formulário para querystring
      function qs(){
        const params = new URLSearchParams();
        ['autor','orientador','curso','tipo','data_inicial','data_final'].forEach(name => {
          const el = form.querySelector(`[name="${name}"]`);
          const val = el && typeof el.value === 'string' ? el.value.trim() : '';
          if(val) params.append(name, val);
        });
        return params.toString();
      }

      // Pager handlers
      if(pgPrev) pgPrev.addEventListener('click', ()=>{ if(page>1){ page--; renderTable(); } });
      if(pgNext) pgNext.addEventListener('click', ()=>{
        const totalPages = Math.max(1, Math.ceil(allRows.length / pageSize));
        if(page < totalPages){ page++; renderTable(); }
      });
      if(pgSize) pgSize.addEventListener('change', ()=>{
        pageSize = parseInt(pgSize.value, 10) || 10;
        page = 1;
        renderTable();
      });

      function updateDownloadURLs(){
        const q = qs();
        const colsParam = selectedCols.join(',');
        const base = '/relatorio/exportar';
        const common = q ? ('?' + q + '&cols=' + encodeURIComponent(colsParam)) : ('?cols=' + encodeURIComponent(colsParam));
        if(btnExcel) btnExcel.dataset.url = base + common;
        if(btnPDF) btnPDF.dataset.url = base + common + '&format=pdf';
      }

      async function doPreview(){
        saveFilters();
        updateDownloadURLs();
        const url = '/relatorio/preview' + (qs() ? ('?' + qs()) : '');
        try{
          tableBody.innerHTML = '';
          empty.style.display = 'none';
          allRows = [];
          count.textContent = 'Carregando...';
          const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
          if(!resp.ok){ throw new Error('Falha ao obter preview'); }
          const data = await resp.json();
          const rows = data && Array.isArray(data.rows) ? data.rows : [];
          allRows = rows;
          page = 1;
          renderTable();
          openModal();
        } catch(err){
          count.textContent = 'Erro ao carregar';
          empty.style.display = 'block';
          openModal();
        }
      }

      btnPreview.addEventListener('click', doPreview);
      form.addEventListener('submit', function(e){ e.preventDefault(); doPreview(); });

      // UI de progresso (reutilizável)
      function ensureRelProgressUI(){
        const actions = document.getElementById('reportActions') || (modal && modal.querySelector('footer div:last-child'));
        if(!actions) return null;
        let wrap = document.getElementById('relDlWrap');
        if(!wrap){
          wrap = document.createElement('div');
          wrap.id = 'relDlWrap';
          wrap.style.marginLeft = '8px';
          wrap.style.display = 'none';
          wrap.style.gap = '8px';
          wrap.style.alignItems = 'center';
          wrap.style.background = '#F1F5F9';
          wrap.style.borderRadius = '6px';
          wrap.style.padding = '8px';
          const bar = document.createElement('progress');
          bar.id = 'relDlProgress';
          bar.max = 100;
          bar.value = 0;
          bar.style.width = '220px';
          const label = document.createElement('span');
          label.id = 'relDlLabel';
          label.textContent = 'Baixando... 0%';
          wrap.appendChild(bar);
          wrap.appendChild(label);
          actions.appendChild(wrap);
        }
        const bar = wrap.querySelector('progress');
        const label = wrap.querySelector('span');
        // helper de ETA
        function formatEta(sec){
          if(!isFinite(sec) || sec <= 0) return '';
          const s = Math.round(sec);
          const m = Math.floor(s / 60);
          const r = s % 60;
          return m ? `${m}m ${r}s` : `${r}s`;
        }
        return {
          show(){ wrap.style.display='flex'; bar.value=0; label.textContent='Baixando... 0%'; },
          update(p, eta){
            bar.value=p;
            const pct = Math.max(0, Math.min(100, Math.round(p)));
            const etaTxt = (eta && isFinite(eta) && eta > 0) ? ` — ~${formatEta(eta)}` : '';
            label.textContent = `Baixando... ${pct}%${etaTxt}`;
          },
          done(){ bar.value=100; label.textContent='Download concluído com sucesso'; setTimeout(()=>{ wrap.style.display='none'; }, 1600); },
          fail(){ label.textContent='Falha no download'; wrap.style.display='flex'; }
        };
      }

      async function handleDownload(btn){
        const progress = ensureRelProgressUI();
        let toast;
        const url = btn && btn.dataset && btn.dataset.url ? btn.dataset.url : btn.getAttribute('href') || '#';
        if(!url || url === '#') return;

        btn.setAttribute('aria-busy','true');
        btn.classList.add('is-disabled');
        toast = window.showToast && window.showToast('Efetuando o download...', 'info', { timeout: 0 });

        // Fluxo FS API primeiro: perguntar onde salvar ANTES de iniciar a rede
        if(window.showSaveFilePicker){
          try{
            const pick = await window.showSaveFilePicker({
              suggestedName: 'relatorio',
              types: [{ description: 'Arquivo', accept: { 'application/octet-stream': ['.xlsx','.csv','.pdf'] } }]
            });
            const writable = await pick.createWritable();

            const resp = await fetch(url, { method: 'GET' });
            if(!resp.ok) throw new Error('Falha ao iniciar download');

            const total = parseInt(resp.headers.get('Content-Length') || '0', 10);
            const reader = resp.body && resp.body.getReader ? resp.body.getReader() : null;

            let received = 0;
            const startMs = Date.now();
            if(progress) progress.show();
            function updateEta(){
              if(!total || !progress) return;
              const elapsed = (Date.now() - startMs) / 1000;
              const speed = elapsed > 0 ? (received / elapsed) : 0;
              const remaining = total - received;
              const eta = (speed > 0 && remaining > 0) ? (remaining / speed) : null;
              progress.update((received/total)*100, eta);
            }

            if(reader){
              while(true){
                const {done, value} = await reader.read();
                if(done) break;
                await writable.write(value);
                received += (value && value.length) ? value.length : 0;
                updateEta();
              }
            } else {
              const blob = await resp.blob();
              await writable.write(blob);
              received = total || (blob && blob.size) || received;
              updateEta();
            }
            await writable.close();

            if(progress) progress.done();
            if(toast && toast.remove) toast.remove();
            window.showToast && window.showToast('Efetuado com sucesso!', 'success');
            closeModal();
          } catch(err){
            const msg = String((err && err.message) || '').toLowerCase();
            const name = (err && err.name) || '';
            if(name === 'AbortError' || /abort|cancel/.test(msg)){
              const wrapEl = document.getElementById('relDlWrap');
              if(wrapEl) wrapEl.style.display = 'none';
              if(toast && toast.remove) toast.remove();
              window.showToast && window.showToast('Operação cancelada pelo usuário', 'info');
            } else {
              if(progress) progress.fail();
              if(toast && toast.remove) toast.remove();
              window.showToast && window.showToast('Falha no download', 'error');
            }
          } finally {
            btn.removeAttribute('aria-busy');
            btn.classList.remove('is-disabled');
          }
          return; // não segue para fallback se FS API existe
        }

        // Fallback: sem File System Access API, baixa via blob/ancora
        try{
          const resp = await fetch(url, { method: 'GET' });
          if(!resp.ok) throw new Error('Falha ao iniciar download');

          // Nome do arquivo (sugerido pelo servidor)
          let filename = 'relatorio';
          const cd = resp.headers.get('Content-Disposition') || '';
          const mStar = /filename\*=(?:UTF-8''|)([^;]+)/i.exec(cd);
          const m = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/i.exec(cd);
          const rawName = (mStar && mStar[1]) || (m && m[1]);
          if(rawName){
            try{ filename = decodeURIComponent(String(rawName).replace(/['"]/g, '')); }catch(_){ filename = String(rawName).replace(/['"]/g, ''); }
          }

          const mime = resp.headers.get('Content-Type') || '';
          const total = parseInt(resp.headers.get('Content-Length') || '0', 10);
          const reader = resp.body && resp.body.getReader ? resp.body.getReader() : null;

          let received = 0;
          const startMs = Date.now();
          if(progress) progress.show();
          function updateEta(){
            if(!total || !progress) return;
            const elapsed = (Date.now() - startMs) / 1000;
            const speed = elapsed > 0 ? (received / elapsed) : 0;
            const remaining = total - received;
            const eta = (speed > 0 && remaining > 0) ? (remaining / speed) : null;
            progress.update((received/total)*100, eta);
          }

          if(reader){
            const chunks = [];
            while(true){
              const {done, value} = await reader.read();
              if(done) break;
              chunks.push(value);
              received += (value && value.length) ? value.length : 0;
              updateEta();
            }
            const blob = new Blob(chunks, { type: mime || 'application/octet-stream' });
            const objectURL = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = objectURL; a.download = filename || 'relatorio';
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(objectURL);
          } else {
            const blob = await resp.blob();
            const objectURL = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = objectURL; a.download = filename || 'relatorio';
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(objectURL);
          }

          if(progress) progress.done();
          if(toast && toast.remove) toast.remove();
          window.showToast && window.showToast('Efetuado com sucesso!', 'success');
          closeModal();
        } catch(err){
          if(progress) progress.fail();
          if(toast && toast.remove) toast.remove();
          window.showToast && window.showToast('Falha no download', 'error');
        } finally {
          btn.removeAttribute('aria-busy');
          btn.classList.remove('is-disabled');
        }
      }

      btnExcel && btnExcel.addEventListener('click', function(ev){ ev.preventDefault(); handleDownload(btnExcel); });
      btnPDF && btnPDF.addEventListener('click', function(ev){ ev.preventDefault(); handleDownload(btnPDF); });

      // Event listeners dos botões de coluna
      btnColsAll && btnColsAll.addEventListener('click', function(){
        const checkboxes = colBoxes.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = true);
        updateSelectedCols();
      });

      btnColsNone && btnColsNone.addEventListener('click', function(){
        const checkboxes = colBoxes.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => {
          if((cb.dataset && cb.dataset.key) === 'titulo' || cb.value === 'titulo') cb.checked = true; // manter título
          else cb.checked = false;
        });
        updateSelectedCols();
      });

      // Inicialização
      loadSavedFilters();
      loadSavedCols();
      renderColumnControls();
      buildHeader();
    })();
  </script>
</body>
</html>
